<?php
/**
 * @file
 * Code for the OMBU Media feature.
 */

include_once 'ombumedia.features.inc';


/**
 * Implements hook_menu().
 */
function ombumedia_menu() {
  $items['admin/dashboard/manage-media'] = array(
    'title' => 'Manage Media',
    'type' => MENU_CALLBACK,
    'page callback' => 'ombumedia_page_magage_media',
    'access arguments' => array('administer files'),
  );

  $items['admin/dashboard/manage-media/ajax-upload'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'ombumedia_page_magage_media_ajax_upload',
    'access arguments' => array('administer files'),
  );

  return $items;
}

/**
 * Implements hook_theme().
 */
function ombumedia_theme($existing, $type, $theme, $path) {
  return array(
    'ombumedia_page' => array(
      'variables' => array(
        'media_library' => '',
        'mode' => 'manage',
      ),
      'template' => 'ombumedia_page',
    ),
  );
}

/**
 * Page callback for Manage Media page.
 */
function ombumedia_page_magage_media() {
  $view = views_get_view('ombumedia');
  $view->set_display('manage_media');
  $view->pre_execute();
  $view->execute();
  $view_rendered = $view->preview();


  return theme('ombumedia_page', array(
    'media_library' => $view_rendered,
  ));
}

/**
 * Page callback for Manage Media Ajax Upload page.
 */
function ombumedia_page_magage_media_ajax_upload() {
  module_load_include('inc', 'file_entity', 'file_entity.pages');
  $errors = array();
  if ($file = file_save_upload(0)) {

    $type_candidates = file_entity_get_filetype_candidates($file);

    if (count($type_candidates) >= 1) {

        if ($moved_file = file_move($file, 'public://' . file_uri_target($file->uri), FILE_EXISTS_RENAME)) {
          $type_candidates_keys = array_keys($type_candidates);
          $file = $moved_file;
          $file->type = reset($type_candidates_keys);;
        }
        else {
          $errors[] = 'Error saving file.';
        }

    }
    else {
      $errors[] = 'Unrecognized file type.';
    }

  }
  else {
    $errors[] = 'Invalid request';
  }

  if (empty($errors)) {
    $file->display = TRUE;
    $file->status = FILE_STATUS_PERMANENT;
    file_save($file);
    $file = file_load($file->fid);
    drupal_json_output(array(
      'file' => (array) $file,
    ));

  }
  else {
    drupal_json_output(array('errors' => $errors));
  }
  drupal_exit();
}

/**
 * Implements hook_preprocess_ombumedia_page().
 */
function ombumedia_preprocess_ombumedia_page(&$variables) {
  $path = drupal_get_path('module', 'ombumedia');
  drupal_add_js($path . '/js/ombumedia-util.js');
  drupal_add_js($path . '/js/ombumedia-library.js');
  drupal_add_css($path . '/css/ombumedia.css');

  $ombumedia_settings = array(
    'ombumedia' => array(
      'upload' => array(
        'url' => url('admin/dashboard/manage-media/ajax-upload'),
      ),
    ),
  );

  if ($variables['mode'] === 'manage') {
    drupal_add_js($path . '/js/init-manage.js');
  }

  drupal_add_js($ombumedia_settings, 'setting');
}

/**
 * Implements hook_preprocess_views_view_unformatted().
 */
function ombumedia_preprocess_views_view_unformatted(&$variables) {
  if ($variables['view']->name === 'ombumedia') {
    $results = $variables['view']->result;
    foreach ($variables['rows'] as $i => $row) {
      $data_fid = 'data-fid="' . $results[$i]->fid . '"';
      $row = '<a href="#preview" ' . $data_fid . '>' . $row . '</a>';
      $row .= implode(' ', array(
        '<span class="actions">',
        '<a href="#select" ' . $data_fid . '>Select</a>',
        '<a href="#edit" ' . $data_fid . '>Edit</a>',
        '<a href="#delete" ' . $data_fid . '>Delete</a>',
        '</span>',
      ));
      $variables['rows'][$i] = $row;
      $variables['classes_array'][$i] .= ' ombumedia-library-file';
    }
  }
}
